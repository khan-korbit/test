name: Gitleaks Scan

on:
  pull_request:
    branches: [ main ] # main ë¸Œëœì¹˜ë¡œì˜ PRì— ëŒ€í•´ì„œë§Œ ì‹¤í–‰
  # push ì´ë²¤íŠ¸ëŠ” main ë¸Œëœì¹˜ ë³‘í•© ì‹œì—ë§Œ ìŠ¤ìº”í•˜ë„ë¡ ì œí•œí•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
  # push:
  #   branches: [ main ]

jobs:
  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # PRì˜ ëª¨ë“  ì»¤ë°‹ì„ ê°€ì ¸ì™€ì•¼ ë¹„êµê°€ ê°€ëŠ¥í•˜ë¯€ë¡œ fetch-depthëŠ” 0ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
        with:
          fetch-depth: 0

      - name: Setup Gitleaks baseline
        # main ë¸Œëœì¹˜ì— ìˆëŠ” ë² ì´ìŠ¤ë¼ì¸ íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        # PR íƒ€ê²Ÿ ë¸Œëœì¹˜ê°€ mainì´ ì•„ë‹ ê²½ìš°, 'origin/${{ github.base_ref }}' ë“±ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        run: |
          git checkout origin/main -- gitleaks-baseline.json
          if [ ! -f gitleaks-baseline.json ]; then
            echo "Baseline file not found. Creating an empty one to prevent errors."
            echo "[]" > gitleaks-baseline.json
          fi

      - name: Run Gitleaks Scan on Pull Request
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          # ë² ì´ìŠ¤ë¼ì¸ íŒŒì¼ì„ ê¸°ì¤€ìœ¼ë¡œ ìƒˆë¡œìš´ íƒì§€ ê±´ë§Œ ë³´ê³ í•˜ë„ë¡ ì„¤ì •
          baseline_path: gitleaks-baseline.json
        # ì´ ìŠ¤í…ì€ ìƒˆë¡œìš´ íƒì§€ ê±´ì´ ìˆì„ ë•Œë§Œ ì‹¤íŒ¨í•©ë‹ˆë‹¤.

      - name: Gitleaks scan passed
        if: success()
        run: echo "âœ… Gitleaks scan passed. No new leaks found."

      - name: Send Slack notification on failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: "ğŸš¨ Gitleaks Alert: New Secrets Detected in PR!"
          SLACK_MESSAGE: |
            A Gitleaks scan detected potential new secrets in Pull Request #${{ github.event.pull_request.number }}.
            Author: @${{ github.actor }}
            Please review the findings in the 'Gitleaks Scan' check and take immediate action.
            PR Link: ${{ github.event.pull_request.html_url }}
          SLACK_COLOR: 'danger'
          SLACK_USERNAME: "Gitleaks Bot"
          SLACK_ICON_EMOJI: ":gitleaks:"
          MSG_MINIMAL: true
