# .github/workflows/gitleaks_baseline.yml
name: Gitleaks Scan with Baseline & Slack Notify

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  gitleaks-check:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Baseline íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ê¸°ì¡´ ì´ìŠˆ ë¬´ì‹œìš©)
      - name: Download baseline
        run: |
          # baseline.jsonì€ ë¦¬í¬ì§€í† ë¦¬ì— ë¯¸ë¦¬ ì»¤ë°‹í•´ ë‘ì„¸ìš”.
          if [ ! -f ./baseline.json ]; then
            echo "â— baseline.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì²˜ìŒ ìŠ¤ìº” ì‹œì—ëŠ” --create-baselineë¡œ ìƒì„± í›„ ì»¤ë°‹í•˜ì„¸ìš”."
            exit 0
          fi

      # 3ï¸âƒ£ Gitleaks ìŠ¤ìº” (Baseline ì ìš©)
      - name: Run Gitleaks with baseline
        id: gitleaks
        run: |
          echo "ğŸ” Running Gitleaks with baseline..."
          gitleaks detect \
            --baseline-path baseline.json \
            --exit-code 1 \
            --report-format sarif \
            --report-path gitleaks.sarif
        continue-on-error: true

      # 4ï¸âƒ£ Slack ì•Œë¦¼ (ì‹ ê·œ ì´ìŠˆ ë°œê²¬ ì‹œ)
      - name: Notify Slack on new leaks
        if: steps.gitleaks.outcome == 'failure'
        uses: slackapi/slack-github-action@v2.1.0
        with:
          payload: |
            {
              "text": ":rotating_light: *[Gitleaks] ì‹ ê·œ ë¯¼ê° ì •ë³´ íƒì§€!* :lock:\nâ€¢ ì €ì¥ì†Œ: `${{ github.repository }}`\nâ€¢ ì‹¤í–‰ URL: `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # 5ï¸âƒ£ ì›Œí¬í”Œë¡œ ì‹¤íŒ¨ ì²˜ë¦¬ (ë¨¸ì§€ ì°¨ë‹¨)
      - name: Block merge on new leaks
        if: steps.gitleaks.outcome == 'failure'
        run: |
          echo "ğŸš« New leaks detected. Failing workflow to block merge."
          exit 1
