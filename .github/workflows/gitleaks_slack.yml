# .github/workflows/gitleaks_baseline.yml
name: Gitleaks Scan with Baseline & Slack Notify

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 전체 Git 히스토리를 가져와 스캔

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        # Gitleaks가 유출을 탐지하면 non-zero exit code를 반환하여 이 스텝은 실패합니다.
        # 실패 시 이후 스텝(Slack 알림)이 조건부로 실행됩니다.

      - name: Gitleaks scan passed
        if: success()
        run: echo "✅ Gitleaks scan passed. No leaks found."

      - name: Send Slack notification on failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: "🚨 Gitleaks Alert: Secrets Detected!"
          SLACK_MESSAGE: "A Gitleaks scan detected potential secrets in a recent commit. Please review the findings and take immediate action."
          SLACK_COLOR: 'danger' # 또는 16진수 색상 코드
          SLACK_USERNAME: "Gitleaks Bot"
          SLACK_ICON_EMOJI: ":gitleaks:"
          MSG_MINIMAL: true
